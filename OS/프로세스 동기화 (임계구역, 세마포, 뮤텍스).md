## 프로세스 동기화 (임계구역, 세마포, 뮤텍스)





#### 프로세스 동기화 === 쓰레드 동기화

협력적 프로세스는 쓰레드를 통해서 논리주소공간을 직접 공유할 수 있다. 이 협력적 프로세스는 다른 ps에게 영향을 주거나 받을 수 있으므로 서로 영향을 미쳐 **동기화**가 중요하다. 

ps, 쓰레드 사이에 동기화 하는 것을 프로세스 또는 쓰레드 동기화라고한다.



#### 임계영역



- 공유된 자원을 여러 쓰레드가 접근하고 순서없이 수행하면 안된다.
  - ex)은행 돈 인출시 동시에 접근해서 잔액조회를 했을때 A가 100, B도 100만원이라고 해보자, A가 먼저 20만원을 인출하고 B도 10만원을 인출했는데 잔액이 갱신되지 않고 B의 인출명령을 수행하여 100만원에서 10만원이 인출되어 잔액이 90만원이 남게된다. 이처럼 공유 데이터를 동시에 접근하면 문제가 발생하므로 문제가 발생하지 않게 공유자원에 대한 독점을 보장해주는 영역을 임계영역이라 부른다.

- 여러개의 쓰레드,프로세스는 각각의 코드 영역을 갖고 있는데 이를 **임계영역**이라 한다.

- 임계영역안에서는 하나 이상의 다른 프로세스와 공유하는 데이터에 접근 및 갱신할 수 있다.
- 수행되는 프로세스가 있다면 해당 구역에 다른 프로세스가 접근할 수 없다 즉, 한번에 하나만 수행할 수 있다.
- 이 임계구역 동시접근을 해결하기 위한 방법으로 세마포, 뮤텍스락, 모니터가 있는 것이다

##### 임계구역 문제

임계구역으로 지정되지 않았을 때 발생할 수 있는 문제에 대한 해결방안 3가지

- 상호배제 : 하나의 ps가 임계구역에 있다면 다른 ps는 들어갈 수 없음
- 진행 :  임계구역에 들어간 ps가 없는 상태에서 들어가려고 하는 ps가 여러개 있으면 어느 것이 들어가야할 지를 결정해주어야함
- 한정된 대기 : ps가 임계구역에서 나오지 않으면 다른 ps를 실행시킬 수 없으므로 한 번들어간 ps는 다음번에 들어갈 때 제한을 줘야함



#### peterson의 해결안

임계구역에 대한 SW기반 해결책

임계구역, 나머지 구역을 번갈아 가며 실행하는 **2개의 프로세스**로 한정

자신의 turn이 올때까지 둘 중 하나의 ps는 while문에 갇히고 하나는 임계영역에 진입.

위의 임계영역 3가지 문제에 대해 해결책을 보여줌

[참고링크 코드](https://jhnyang.tistory.com/37)



### 뮤텍스 락

임계구역 문제를 해결하기 위한 도구이고 임계구역을 보호하고 경쟁 조건을 방지하기 위해 사용함

MUTual Exclusion

- 임계구역에 들어가기전에 반드시 락을 획득해야하고 빠져나올 때 락을 반환해야한다.
  - `acquire() 락 획득, release() 락 반환`
  - `available`은 불린변수 락의 가용 여부를 표시 => true이면 `락획득. 이후 획득하려는 시도는 락이 반환될 때 까지 봉쇄`

### 세마포

세마포는 정수 변수

세마포 값이 0이면 모든 자원이 사용중인 상태

이 후 자원을 사용하려는 ps는 세마포 값이 0보다 커질 때 까지 봉쇄된다.



 상호배제를 구현



#### 세마포의 함수

세마포는 가용한 자원의 갯수로 초기화됨

ps가 각 자원을 사용하려는 ps는 `wait()`연산을 수행하며 세마포 값을 감소시킴

ps가 자원을 방출할 때 `signal()`을 수행하며 세마포를 증가시킴



`wait()`수행시 세마포가 음수면 해당 프로세스 대기 -> 자신을 대기큐에 삽입, CPU스케줄러는 다른 ps를 실행하기 위해 선택

대기된 ps는 다른 ps가 `signal()`연산을 실행하며 재시작됨(큐에서 빠져나옴), `wakeup()`에 의해 시작됨.



ps가 세마포를 기다려야할 때 프로세스 리스트에

**추가**되며 `signal()`호출 후 `wakeup()`에 의해 리스트에서 **꺼내어짐**으로써 수행될 수 있음.