

###### 1. 학습 날짜

- 2020 - 08 - 19(수)

---

###### 2. 학습시간

- 10:00 ~ 18:00

---

###### 3. 학습 범위 및 주제

- ft_server

---

###### 4. 동료 학습 방법 

- daelee, taelee, jehong, mihykim

---

###### 5. 학습 목표 

- ft_server에 대해 학습

---

###### 6. 상세 학습 내용

- 코드작성시간 :  3시간

## ft_server

<br>

간단하게 다시 해야할 일을 정리해본다면,

도커를 설치한다.

Debian buster OS를 설치한다.

해당 OS에서 모든 작업을 진행한다.

작업해야할 사항은 다음과 같다.

nginx로 웹 서버를 구축하고 구동한다.

nginx는 https로 접속이 가능한 SSL프로토콜을 적용한다.

루트 디렉토리의 파일들을 자동으로 리스팅해주는 오토인덱싱을 설정한다.

오토인덱싱은 url에 리소스명을 입력하지 않고 리스트형식으로 리소스들을 나열해주는 것을 의미한다.

데이터베이스 사용을 위한 Mysql(mariaDB)를 설치한다.

웹 상에서 DB를 조작 및 관리하는 php로 작성된 데이터베이스 관리 툴, phpMyadmin을 설치 및 적용한다.

CMS (Contents Management System) 콘텐츠 관리 시스템인, WordPress를 설치 및 적용한다.

CMS란 웹 상에 올리는 사진, 영상, 파일 등을 웹 문서로 만들어 주는 소프트웨어. 즉, 사이트를 편하게 관리할 수 있는 툴이고 UI/UX를 제공하는 테마, 그리고 플러그인을 제공하는 기능을 합친 것이 워드프레스이다.



서버(nginx)

DB(Mysql) - DB관리(phpMyAdmin)

View(WordPress)라고 이해하면 편할 것 같다.



<br>

먼저 클러스터 환경에서는 용량문제가 발생할 수 있으니 `goinfre`에서 작업하며 작업을 진행하기 전에 `42toolbox.`를 받아 진행한다.



### 환경 세팅하기 

```shell
$ ~/goinfre
$ git clone https://github.com/alexandregv/42toolbox.git
$ echo "source ~/42toolbox/shell\_utils.sh" >> ~/.zshrc
$ cd 42toolbox
$ sh init_docker.sh
```



이 후 `goinfre/docker/com.docker.docker/Data` 에서 작업하면됨!



`docker ps`로 설치가 잘되었는지 확인까지 마무리하면 이제 진짜 시작~

<br>

### 이미지 생성

OS이미지를 다운로드 받는다

`docker pull debian:buster`

`docker images`로 현재 이미지를 확인할 수 있다.

<br>

### 생성한 이미지로 컨테이너 구동

`docker run -it -p 80:80 -p 443:443 Debian:buster`

`-p`옵션은 호스트(맥)과 컨테이너(debian이미지로 구동되는 환경)의 포트를 연결하는 옵션이다.

Mac에서 인터넷을 켜서 해당 포트로 접근하면 컨테이너에서 접속한 것 처럼 보여지는 포트포워딩을 진행하는 것 같다.

80포트는 웹 서버의 기본포트로 사용하고 443은 SSL를 위한 포트이다.

위 명령어로 컨테이너를 구동시켜보자.



### nginx 설치 및 시작

`apt-get update`

`apt-get -y upgrade`

`apt-get -y install nginx`

위 명령어를 작성하면 nginx가 debian환경에서 설치되며,

`service nginx start`를 하면 웹 서버가 구동되며,

로컬에서 `localhost`를 웹으로 접근하면 nginx가 구동됨을 확인할 수 있다.



<br>

### OpenSSL로 SSL인증서 만들기

[CA없이 인증서 발급하기](https://blog.iwanhae.ga/nginx-ssl-https/)

인증서를 만들기 위해서 `openssl, vim`을 설치한다.

`apt-get -y install openssl vim`

원래는 `letsencrypt` 같은 무료인증서를 발급받을 수 있지만 해당 과제는 배포하는 것도 아니라 자체인증으로 쉽게 진행할 수 있다.

~~localhost에 CA인증을 같이 해도 되는지 모르겠음, 아마 안될 것 같음 도메인네임이 필요하기 때문에..?~~

따라서 자체인증 하는 법을 정리하도록 하겠다.

HTTPS를 위해서는 개인키(.key), 서면요청파일(.csr), 인증서파일 (.crt)가 필요하다.

`openssl`로 이를 발급받을 수 있다.

`openssl req -new -newkey rsa:2048 -nodes -keyout server.key -out server.csr -subj "/C=KO/ST=SU/L=SE/O=42/OU=IT/CN=domain.com" ` 로 key와  csr파일이 생성된다. 

`-subj`옵션을 사용하면 작성해야하는 정보들을 명령어에 함꼐 넣을 수 있다. [공식문서](https://www.digicert.com/kb/ssl-support/openssl-quick-reference-guide.htm)

그리고 나서

`openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt`로 crt파일이 완성이 되는데 nginx에서 key,crt파일만 필요하다. 

이를 적당한 곳에 위치시킨다. 나는 `/etc/ssl/certs`에 `crt`파일을, `/etc/ssl/private`에  `key`파일을 위치시켰다.

<br>

#### nginx에 SSL설정하기

ssl을 설정하기 위해서 `/etc/nginx/site-enables/default` 파일을 약간 설정해주어야한다.

내용은 다음과 같다.

server블록을 따로 만들어 그 안에 443포트를 열고, ssl on, ssl인증서를 적용하기 위한 경로설정을 진행한다.

설정 코드는 다음과 같다.

~~왜 맥에서 코드블럭 단축키가 안되는거야!!!~~



```shel;
server{
	listen 443;
	
	ssl on;
	ssl_certificate /etc/ssl/certs/server.crt;
	ssl_certificate_key /etc/ssl/private/server.key;
	
	server_name _;
}
```

이처럼 설정파일을 작성하고, `service nginx restart`로 재시작을 해준 다음, `https://localhost`로 접속하면 ~~https://~~localhost로 접근이 되는 것을 확인할 수 있다.



지금까지 한 이미지 설정을 저장하고 싶으면 어떻게 할까?

dockerHub을 이용해볼까?



### DockerHub

<br>

DockerHub는 github처럼 이미지 버전관리?와 같은 서비스이다.

먼저, 회원가입을 진행하고 레포지토리 생성까지 진행해본다.

나는 ft_server라는 이름의 레포지토리를 생성했다.

`docker push seongsangcho/ft_server:tagname`

레포지토리에 들어가니 친절하게 push해주는 명령어를 알려주고 있다.

그렇다면 이미지를 어떻게 커밋하고, 푸쉬할까?

어떻게 경로를 지정해줄까? 이는 매우 간단했다.

 

<br>

#### dockerHub에 이미지 commit, push, pull하기

push하기 위해 제일 먼저 해야할 일은 로그인이다.

`docker login`을 하면 id와 pw를 쳐준다 .

로그인이 되었다면 이미지 태그를 구성해야한다.

도커 이미지 이름은 다음과 같은 형태로 구성된다.



[도커허브의 Registry URL]/[사용자 ID]/[Image명]:[Tag]

레지스트리와 사용자 아이디는 알겠는데, 이미지명하고 태그명은 뭘까?

`docker images`로 이를 확인할 수 있다.

나는 Repository가 github로 따지면 연결될 원격저장소의 URL,

TAG는 커밋메세지 처럼 생각하고 있다.

따라서 도커허브에 push하기 위해 이를 맞춰주는 과정이 필요하다.





`docker tag image ID 레포지토리ID/레포지토리명:태그`

이해가 잘 안갈듯한데, 하나하나 설명해보겠다.



계정명 : seongsangcho

레포지토리이름 : ft_server

이미지명 : 48c8d.....로 현재 구성했다.



내가 작성한 명령어는 다음과 같다.

`docker tag 48c8d.. seongsangcho/ft_server:nginxSSL`

태그명은 각자 알아보기 쉽게 지정해주면 될듯하다.



푸쉬하기전에,  commit을 수행해야하는데, 현재 컨테이너 상태를 커밋해보자.

커밋하기 위해선 컨테이너와 이미지의 아이디만 있으면 된다.

먼저 현재 실행중인 컨테이너의 아이디를 확인해보자

`docker ps`명령어로 container의 아이디를 얻을 수 있다.

`docker images` 로 이미지의 아이디를 얻을 수 있다.

그리고 `docker commit 컨테이너id 이미지id` 로 커밋을 할 수 있다.

`docker push seongsangcho/ft_server:tagname` 를 통해 push해보자

~~tag를 굳이 안해도 push할 수 있네, 근데 알아보기 쉽도록 tag를 꼭 지정해두도록 하자.~~



pull받는 방법도 매우 간단하다.

`docker pull seongsangcho/ft_server:nginxSSL`하면 받을 수 있다.

한번 현재 생성된 모든 이미지를 지우고, 도커허브의 내 이미지를 다운받아 지금까지 작업한 것이 유지가 잘 된다! =>~~요새는 도커보다 aws 람다를 더 쓴다는데 알아봐야겠다~~

[도커허브 관리하기](https://subicura.com/2017/02/10/docker-guide-for-beginners-create-image-and-deploy.html)





### php-fpm 설치

먼저, php파일을 생성한다.

위치는 `/var/www/html/phpinfo.php`로 하고 내용은

`<?php phpinfo(); ?>` 로 작성한다.

그리고 설치를 진행한다.

`apt-get -y install php-fpm`

`vim etc/nginx/sites-available/default`에서 

`Fast CGI server 부분을 변경한다.`

```shell
#pass PHP scripts to FastCGI server
   location ~ \.php$ {
   include snippets/fastcgi-php.conf;
       fastcgi_pass unix:/run/php/php7.3-fpm.sock;
   }## 여기 끝에 주석을 제거해주는 것을 잊지말자.
```



`service php7.3-fpm start` 로 php를 실행한 다음,

`localhost/phpinfo.php`로 접속하여 원활하게 접속이 되는지 확인한다.





### Mysql(mariadb)

일전에 debian에서 mysql을 설치하려했는데 패키지가 없어서 못했었다.

데비안 9 부터 mariaDB를 디폴트로 사용한다고 한다.

`apt-get -y install mariadb-server php-mysql`로 설치한다.



현재 debian에 phpmyadmin을 직접 다운로드 할 수 없으므로, wget을 설치하여 직접 설치하도록 한다. 설치명령어는 다음과 같다.



```shell
$ apt-get install -y wget
$ wget https://files.phpmyadmin.net/phpMyAdmin/5.0.2/phpMyAdmin-5.0.2-all-languages.tar.gz
$ tar -xvf phpMyAdmin-5.0.2-all-languages.tar.gz
$ mv phpMyAdmin-5.0.2-all-languages phpmyadmin
$ mv phpmyadmin /var/www/html/
```

<br>

설치가 완료되었다면, phpmyadmin설정을 해야한다. 

phpmyadmin/config.sample.inc.php를 복사해 config.inc.php를 생성한다. 경로는 다음과 같다.

`/var/www/html/phpmyadmin/config.sample.inc.php`

~~그리고 [암호생성기](http://www.passwordtool.hu/blowfish-password-hash-generator)를 통해서 config.inc.php파일의 $cfg['blowfish_secret'] ='암호삽입'; 을 진행한다. 나는 아무런 암호를 쓰지 않고 바로 generate해서 해당 값을 넣었다.~~

### mysql 비밀번호 설정 및 접속 계정 권한설정

nginx를 재시작, mysql를 start한다.

그리고 다음 작업을 수행한다.

```shell
$ mysql < /var/www/html/phpmyadmin/sql/create_tables.sql -u root --skip-password #mysql을 실행하며, 다음 sql문을 root계정으로 접속하여 실행하는 명령

$ mysqladmin -u root -p password	#비밀번호 설정 및 접속
비밀번호 입력

mysql
create database if not exists wordpress;
grant all privileges on *.* to '접속할 계정명'@'%' identified by '설정한 비밀번호' with grant option;

flush privileges;
exit
```



`service mysql start`로 다시 시작하며, `localhost/phpmyadmin`에 접속하여 계정으로 접속하여 제대로 되는지 확인한다.



오마이갓. docker hub에 올리고 다시 pull받아 확인해보려는데, 접속이 되지 않아 restart를 하려는데 `[FAIL] Stopping MariaDB database server: mysqld failed!` ~~하..이거 저번에도 떠서 해결못했던 에런데..~~

`Access denied for user 'root'@'localhost' (using password: NO)`

root@localhost 유저에 대한 접근이 거부되었다는 뜻인데.. 사용하는 비밀번호가 없다고..? 설정해줬는데..



~~mysql설치하고 `root@localhost`에 대한 비밀번호 설정을 안했거나, 비밀번호가 틀려서?(어디에 입력하는건데..?)발생하는 이슈라고 한다.~~

~~YES가 뜨면 비밀번호가 틀린거라고 한다.~~

나는 `ps aux | grep mysql | grep -v grep`명령어를 통해 mysql 프로세스를 끄고, 다시 실행해보았으나 같은 이슈가 발생했고,

`mysql -u root -p`를 통해 설정한 비밀번호를 입력해 접속한 다음,

`use mysql`

`update user set password=PASSWORD('변경할 비밀번호') where user='root';`

`flush privileges;`

`exit`로 root계정의 새로운 비밀번호변경을 하고,

`mysql -u root -p`로 변경된 비밀번호로 다시 접속하고나서 변경을 확인 한 후,

`service mysql restart`를 했는데.. 다시 오류가 발생..

~~뭐가문제야?~~

권한? 권한도 아닐걸..?

`grant all privileges on *.* to '접속할 계정명'@'%' identified by '설정한 비밀번호' with grant option;`

`flush privileges;` 로 이미 권한을 지정해주었는데..ㅎ;

=> **초기 mysqladmin 명령으로 비밀번호 지정할 때 그냥 공백란으로 엔터치셈..** => 근데 이러면 접속할 수 가 없는데? 비밀번호없이 접속할 수 있는걸 찾아볼까 or 접속계정을 하나 추가할까. =>oo.. 루트계정은 비밀번호 없이 진행하고 새로운 계정을 추가하세요. 권한도 주고, 그걸로 접속하면 됩니다. => 아까도 이렇게 했었던거 같은데? 



=> 최종수정

- 권한없이 `mysql -u root -p --skip-password`으로 접속을 해서, mysql의 user테이블에 있는 `root`의 비밀번호를 `use mysql; update user set password=PASSWORD('1234') where user='root'; flush privileges;` set하면 restart도 아무 문제없이 동작하긴 하는데.. secho빼고 접속이 되질 않아.





### WordPress 설치



php, html코드 편집 없이 정리할 수 있는 위젯과 테마를 설치할 수 있다.

검색엔진에 친화적인  오픈소스 블로그 소프트웨어이다.

홈페이지를 깔끔하고 좋게 만들 수 있는 SW.



설치해보자

```sh
wget https://wordpress.org/latest.tar.gz
tar -xvf latest.tar.gz
mv wordpress /var/www/html
chown -R www-data:www-data /var/www/html/wordpress #에러메시지가 있어도 -R로 인해 출력하지 않으며, apache나 php실행시 수정할 수 있도록 소유자를 변경한다.
```



설치를 완료하고

`/var/www/html/wordpress/wp-config.php에 설정을 추가해야한다.

define으로 되어있는 부분을 mysql에서 사용했던 것으로 변경한다(name, password)



### autoindex추가

nginx에서 파일 list를 자동으로 list화 해주는 autoindex기능을 추가한다.

```sh
location / {
	# First attempt to serve request as file, then
	# as directory, then fall back to displaying a 404.
	autoindex on;
	try_files $uri $uri/ =404;
}

```

**기존 nginx페이지인 `index.nginx-debian.html`을 지워야 오토인덱싱이 적용된 페이지가 나온다.





이 글은 [kchoi의 블로그](https://42kchoi.tistory.com/161?category=888384),[yeosong님 블로그](https://yeosong1.github.io/ftserver-풀이기록)를 참고하며 작성했습니다.





---

###### 7. 학습 내용에 대한 개인적인 총평

- 정리가 마무리되었다. mysql에서 한참 헤멘것 말고 그렇게 어렵지는 않았다.
- 이제 해당 과정을 도커파일로 지시문작성을 하면 마무리 될 것 같다.

###### 8. 다음 학습 계획

- ft_server도커파일로 지시문 작성 및 테스트