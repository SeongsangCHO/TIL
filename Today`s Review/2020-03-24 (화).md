---
###### 1. 학습 날짜

- 2020-03-24(화)
 
---
###### 2. 학습시간

- 12:00 ~ 20:38 (자가)

---
###### 3. 학습 범위 및 주제

-  도커 학습

---
###### 4. 동료 학습 방법 

- slack (saji, yshin, Jiyang, Seongkim)

---
###### 5. 학습 목표 

- 도커 학습

---
###### 6. 과제 제출 repository 주소

http://13.125.198.2:3000/secho/ft_server.git

---
###### 7. 상세 학습 내용

- 코드작성시간 : 5시간 


### Introduction

- phpMyAdmin, Wordpress, SQL database 등 다수 서비스를 돌리는 서버를 "도커"를 이용하여 웹서버를 설치하도록.

### General instruction

- 서버구성에 필요한 모든 파일은 srcs폴더에 넣어야함.

- Dockerfiler은 레포지토리의 루트에 있어야함.

- docker-compose를 사용할 수 없다.

- Wordpress 웹 사이트에 필요한 모든 파일은 srcs폴더에 넣어야함.

  

### Mandatory part

- 하나의 도커 컨테이너에만 Nginx을 사용하여 웹서버를 설정해야함.
- 웹 서버는 여러 서비스를 동시에 실행할 수 있어야 함. Wordpress, phpMyAdmin, MySQL , 이를 동작하는지 확인.
- 서버가 SSL프로토콜을 사용할 수 있어야함. 발급방법https://ndb796.tistory.com/340?category=987004 nginx 적용방법 https://ndb796.tistory.com/341
- URL에 따라 서버가 올바른 웹사이트로 리디렉션되는지 확인.
- 서버가 autoindex을 사용해 실행중이어야 비활성화할 수 있어야함.



## Docker?

-  **컨테이너 기반의 오픈소스 가상화 플랫폼**

  ### -  컨테이너  

  - OS를 주로 가상화한 반면, 격리된 공간에서 프로세스가 동작

  ### - 이미지 

  - 컨테이너 실행에 필요한 파일과 설정값을 포함하고 있는 것.
  - 변하지 않음 (Immutable)



### 도커설치

- ```c
  curl -fsSL https://get.docker.com/ | sudo sh
  // 설치확인하기
  docker version
  ```

- 에러발생 Got permission denied while trying to connect to the Docker daemon socket...

- ```c
  해결
  sudo usermod -a -G docker $USER //docker환경변수 root계정 추가 후 재시작
  sudo reboot
  ```



### 도커 명령어

윈도우설치 https://devofhwb.tistory.com/58

- 이미지로 컨테이너를 생성하는 run 명령

- ```
  $docker run -p 8080:80 nginx:latest
  ```

  - nginx 이미지를 실행하면 컨테이너가 구동된 채로 대기한다. 여기서 -p 옵션은 도커를 실행하는 호스트의 8080 포트를 컨테이너의 80 포트로 연결하도록 설정한다. nginx 이미지는 내부적으로 80 포트를 사용해서 웹 서버를 구동하는데 호스트의 8080 포트와 컨테이너의 80 포트를 연결한 것 docker 명령어를 실행한 콘솔에서 Ctrl+C키를 누르면 컨테이너를 종료

  - ```
    $ docker run -d -p 8080:80 nginx:latest
    ```

    - 컨테이너를 백그라운드로 실행해보자. 아래와 같이 -d 옵션을 사용한다. -d 옵션은 컨테이너의 프로그램을 실행할 때 터미널에 연결하지 않는다

- 옵션참고 http://pyrasis.com/book/DockerForTheReallyImpatient/Chapter20/28 https://subicura.com/2017/01/19/docker-guide-for-beginners-2.html

### 도커 이미지 가져오기

아래 명령어를 사용하면 도커 공식 이미지 저장소에서 이미지를 내려받습니다.

```
$ docker pull [이미지 이름]:[태그]
```

예제를 보도록 하겠습니다, 그럼 도커 공식 이미지 저장소에서 `centos:7` 이미지를 다운받게 됩니다.

```
ex)

$ docker pull centos:7
```

### 이미지 확인하기

```
$ docker images

REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              14.04               7e4b16ae8b23        2 weeks ago         188MB
centos              7                   1e1148e4cc2c        5 weeks ago         202MB
```

### 컨테이너 생성하기

이미지로 컨테이너 생성하기

```
$ docker create [옵션] [이미지 이름]:[태그]
```

예제를 보겠습니다.

```
$ docker create -i -t centos:7
```

- `-i` : 상호 입출력
- `-t` : tty를 활성화하여 bash 쉘을 사용

### 컨테이너 실행하기

만들어진 도커 컨테이너를 실행하는 명령어 입니다.

```
$ docker start centos:7
```

### 컨테이너 들어가기

도커의 내부쉘로 들어가는 명령어 입니다.

```
$ docker attach centos:7
```

### 컨테이너 목록 확인

만들어진 컨테이너 목록을 확인할 수 있습니다.

```
$ docker ps
```

### 컨테이너 만들고 실행하기

위의 `생성 -> 실행 -> 들어가기` 까지 한번에 해주는 명령어 입니다.

```
$ docker run [옵션] [이미지 이름]:[태그] 
```

- `-i` : 상호 입출력
- `-t` : tty를 활성화하여 bash 쉘을 사용

```
ex) $ docker run -i -t ubuntu:14.04
```

### 컨테이너 이름 변경

```
$ docker rename [기존 이름] [변경 하고자 하는 이름]
$ docker rename determined_brattain my_container
```

### 컨테이너 삭제

```
$ docker rm [컨테이너 이름]
```

결과

```
$ docker rm mycentos
mycentos
```

만약 container가 실행 중이면 종료하고 삭제를 하거나 -f 옵션을 이용해서 강제로 삭제를 해야합니다.

```
$ docker stop mycentos
$ docker rm mycentos
$ docker rm -f centos
```

https://jungwoon.github.io/docker/2019/01/11/Docker-1/

도커 워드프레스 mySQL php

- https://dololak.tistory.com/387 워드프레스
- [https://syudal.tistory.com/entry/Ubuntu-1804%EC%97%90-Nginx-PHP-MariaDB-phpmyadmin-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0](https://syudal.tistory.com/entry/Ubuntu-1804에-Nginx-PHP-MariaDB-phpmyadmin-설치하기)

**Container Port 외부로 노출(expose) 하기**

 container 를 생성하면 기본적으로 외부와 통신이 불가능한 상태이다. 따라서 외부와 통신을 위해서는 container를 외부로 노출할 Port를 지정해야한다. 노출할 port를 지정하는 방법은 container 를 생성할때 -p option을 이용하면 된다.  

```
$ docker run -d ***-p 8080:80\*** --name web_svr01 httpd //출처: https://bluese05.tistory.com/53 [ㅍㅍㅋㄷ]
```

명령대로 실행하면, 외부에서 Docker host 의 8080 포트로 요청이 들어오면 web_svr01 컨테이너의 80 포트로 해당 요청을 forwarding 하겠다는 의미이다. 아래와 같이 container 상태를 살펴 보면 8080 -> 80 포트로 forwarding 되어 있는 것을 볼 수 있다.

```
$ docker ps -a //로 확인
```

## 컨테이너 포트

- https://blog.naver.com/alice_k106/220278762795
- https://m.blog.naver.com/alice_k106/220340499760 [-p옵션]

## practice

```
$ docker run -i -t debian //으로 debian 컨테이너에 접속한 상태.
$ apt-get-update
$ apt-get install nginx
$ hostname -I // 현재 Ip확인
$ service nginx start // nginx 사용, 확인된 IP의 도메인 접속

```

![nginx](https://user-images.githubusercontent.com/55486644/77397386-d7e26480-6de8-11ea-965a-9e2079f9da25.JPG)

- debian:buster을 기반으로한 이미지에서 nginx를 설치한 후, 해당 서버에 php를 연동, 그리고 mysql 데이터베이스까지 한꺼번에 연동한 이미지를 생성하도록 하는 dockerfile을 작성. config파일로 연동가능 
- 1.Docker이미지로 debian 환경 만들고 접속해보기
  2.nginx 설치하고 로컬호스트에서 접속해보기(docker port 설정)
  3. Nginx에 php실행시켜 띄워보기(php설치 및 nginx conf 설정)
  4.mysql실행해보기(db를 하나 만들어보기)
  5.phpmyadmin 접속할수 있게 설정해보기(설치 및 conf 설정)
  6.wordpress 접속할수 있게 설정해보기(설치 및 conf 설정)
  7.wordpress에 db적용시켜보기
  8.지금까지 해온걸 dockerfile로 자동화 시키기입니다

## nginx 사용 명령어

- nginx : 웹 서버 SW, apache보다, 동시접속에 유리함

```
// 시작
$ sudo service nginx start
$ sudo systemctl start nginx
$ sudo /etc/init.d/nginx start

// 재시작
$ sudo service nginx restart
$ sudo systemctl restart nginx
$ sudo /etc/init.d/nginx restart

// 중지
$ sudo service nginx stop
$ sudo systemctl stop nginx
$ sudo /etc/init.d/nginx stop

// 상태
$ sudo service nginx status
$ sudo systemctl status nginx

// 설정 reload
$ sudo service nginx reload
$ sudo systemctl reload nginx
$ sudo nginx -s reload

// configuration file syntax check
$ sudo nginx -t //출처 https://twpower.github.io/39-install-nginx-on-ubuntu-by-using-apt-get-and-brief-explanation
```

## ERROR

### [docker 컨테이너 내에서 apt-get Unable to locate package 오류] 

-  apt-get update 실행을 한번 해 주면 
- apt-get install [package] 에서 Unable to locate package 오류가 나지 않음.


### dockerfile 작성하기

https://khj93.tistory.com/entry/Docker-Docker-File-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0-%EB%AA%85%EB%A0%B9%EC%96%B4

### docker hub 사용하기
https://eungbean.github.io/2018/12/03/til-docker-commit/
---
###### 8. 학습 내용에 대한 개인적인 총평

- 도커에 대해 학습했다. 전체적인 개념에 대해서는 이해를 했으나 이를 적용하는데에 있어 어려움이 있었다. 과제에서 제시하는서비스들이 어느정도까지 요구하는지를 모르겠고, 포트설정 등 시작하기전에 알아야할게 많았다. printf처럼 무작정 구현하기보다 자료들을 많이 정리해두면서 천천히 해봐야겠다.
- 윈도우에서 도커를 설치하려했으나 가상화환경이 되지 않아서 우분투에서만 진행하였다. nginx를 설치해 구동했는데, php와 연동이 되지않는 문제가 발생했다. config파일 설정에 대해 조금 정리를 해야할 것 같다.

---
###### 9. 다음 학습 계획 (최소 5줄 이상)

-1. nginx php 환경구축한 후 테스트해보기
-2. 해당 기능을 수행할 수 있는 도커파일 생성해보기
-3. mysql, phpMyAdmin 설치 및 테스트해보기
-4. 이에 해당하는 도커파일 수정하기
-5. 내용 정리