---
###### 1. 학습 날짜

- 2020-03-27(금)
 
---
###### 2. 학습시간

- 15:00 ~ 22:14(자가)

---
###### 3. 학습 범위 및 주제

-  도커 학습

---
###### 4. 동료 학습 방법 

- slack (saji, yshin, Jiyang, Seongkim)

---
###### 5. 학습 목표 

- 도커 학습

---
###### 6. 과제 제출 repository 주소

http://13.125.198.2:3000/secho/ft_server.git

---
###### 7. 상세 학습 내용

- 코드작성시간 : 6시간
### dockerfile 명령어

docker run --rm -it (image name) 

**※ 도커파일 명령어 알아보기 ※**

\- **FROM**: 베이스 이미지를 지정하는 명령어입니다. FROM ubuntu:14.04와 같은 방식으로 사용하고, 버전으로는 latest를 넣을 수도 있습니다. 하지만 가능하면 14.04와 같은 정확한 버전명을 기입

\- **RUN**: 이미지 상의 리눅스 커맨드를 실행하도록 해주는 명령어입니다.

 예를 들어 RUN apt-get -y fortune을 하면 리눅스에서 fortune 라이브러리를 다운로드 받게 됩니다.  여러 개의 명령어가 이어지는 경우 다음과 같이 &&를 이용해 하나의 라인에 명령어를 쓰는 것이 좋습니다.

```
 RUN apt-get update && apt-get install -y fortune
```

\- **CMD**: 이미지 명령을 지정하기 위해 사용하는 명령어입니다. 예를 들어 CMD ["nginx"]라고 입력하면 nginx 서버를 실질적으로 구동시키게 되는 것입니다.

\- **EXPOSE**: 컨테이너에서 공개하고자 하는 포트를 정의하기 위해 사용하는 명령어입니다. 80, 443 등의 포트가 일반적으로 많이 사용됩니다.

\- **ADD**, **COPY**: 이미지 안에 파일을 복사하고자 할 때 사용할 수 있는 명령어입니다. 'COPY jerkins.sh /user/local/bin/jenkins.sh'와 같은 방식으로 사용할 수 있습니다. 이 때 압축을 풀 필요 없이 단순히 이미지 안에 넣을 때는 COPY를 쓰고, 압축까지 푸는 등 후처리가 필요하다면 ADD를 사용합니다.



\- **WORKDIR**: 작업위치를 지정할 때 사용하는 명령어입니다.

```shell
sh에서 수행할 내용들
$ mariadb 시작
$ nginx 시작
$ php fpm시작
$ mkdir /etc/nginx/ssl
$ mv key,crt => /etc/nginx/ssl 이동 || openssl로 생성
$ mv default파일 => /etc/nginx/sites-avaliable 로 이동
$ wget -O /var/www/phpmyadmin4.8.zip https://files.phpmyadmin.net/phpMyAdmin/4.8.2/phpMyAdmin-4.8.2-all-languages.zip
$ unzip /var/www/phpmyadmin4.8.zip -d /var/www // 압출풀기
$ rm 으로 알집 삭제하기
```

아래처럼 ln -s 명령어로 심볼릭 링크를 만들 수 있는데요. 두개의 폴더 경로중 앞에는 원본이고 뒤에는 목적지입니다. 목적지 마지막 서브폴더 이름을 현재 존재하지 않는 이름으로 하면 해당 이름이 심볼릭링크 파일의 이름이 됩니다.

```shell
ln -s 원본폴더_경로 존재하는폴더경로/존재하지않는폴더이름

ln -s /var/www/phpMyAdmin-4.8.2-all-languages /var/www/html/hellodb // html하위에 hellodb라는 폴더가 없으므로 해당 링크파일을 만들고 이 파일은 앞의 all-languages파일을 가리키게 된다.

```

```dockerfile
FROM debian:buster

RUN apt-get update
RUN apt-get install -y nginx && apt-get install -y vim && apt-get install wget && apt-get install -y php7.3-fpm
RUN apt-get install -y php7.3cli php7.3-curl php7.3-gd php7.3-mysql php7.3-mbstring zip unzip
RUN apt-get install -y mariadb-server php-mysql // 루트계정비번 설정 전 -y 뺴야하나

EXPOSE 80
```





- start nginx

- nginx + php 연동 -> etc/nginx/site-available/default 파일 내용변경 + ssl추가

```

server {
	listen 80 default_server;
	listen [::]:80 default_server;
	# SSL configuration
	#
	 listen 443 ssl default_server;
	 server_name _;
	ssl on;
	ssl_certificate /etc/nginx/ssl/ft_server.crt;
	ssl_certificate_key /etc/nginx/ssl/ft_server.key;

	root /var/www/html;
	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm index.nginx-debian.html;
	server_name _;
	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	location ~ \.php$ {
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
		fastcgi_pass unix:/run/php/php7.3-fpm.sock;
		fastcgi_read_timeout 300;

	}

	location ~ /\.ht {
		deny all;
	}
}

```



- /var/www/html/index.php파일생성

```
<?php phpinfo(); ?>
```

- php7.3-fpm 실행 및 nginx restart

```shell
$ service php7.3-fpm start
$ service nginx restart
```

- mariadb, mysql설치

- ```shell
  $ apt-get install -y mariadb-server php-mysql
  ```

  - 에러발생하므로 심볼릭링크로 소켓설정

  - ```shell
    $ ln -s /tmp/mysql.sock /var/lib/mysql/mysql.sock
    $ service mysql start
    ```

    ## phpMyAdmin 설치

    ```shell
    $ wget -O /var/www/phpmyadmin4.8.zip https://files.phpmyadmin.net/phpMyAdmin/4.8.2/phpMyAdmin-4.8.2-all-languages.zip
    $ unzip /var/www/phpmyadmin4.8.zip -d /var/www // 압축풀기
    $ mv phpmyadmin4.8 phpmyadmin // 이름변경할필요있을거같은데?
    ```

    #### mysql 설정

    ```shell
    echo "CREATE DATABASE wordpress;" | mysql -u root --skip-password
    echo "GRANT ALL PRIVILEGES ON wordpress.* TO 'root'@'localhost' WITH GRANT OPTION;" | mysql -u root --skip-password 
    
    # mysql> create database wordpress; mysql> grant all privileges on wordpress.* to wordman@localhost identified by 'wordmanpw' with grant option;
    
    # wordpress.*은 wordpress 라는 DB에 속하는 모든 테이블에 권한을 부여한다는 것
    # root@localhost는 root 사용할 사용자이름, localhost는 접속위치
    # 'wordmanpw'는 사용할 패스워드 입력
    # 출처: https://webdir.tistory.com/98 [WEBDIR]
    echo "update mysql.user set plugin='mysql_native_password' where user='root';" | mysql -u root --skip-password
    echo "FLUSH PRIVILEGES;" | mysql -u root --skip-password
    ```

    ## 비밀번호 설정부분 따로 해주지 않아도 됨 

    ```shell
    $ use mysql | mysql -u root
    $ sudo mysql -u root
    MariaDB [(none)]> use mysql;
    MariaDB [mysql]> update user set plugin='mysql_native_password' where user='root';
    MariaDB [mysql]> flush privileges;
    MariaDB [mysql]> quit;
    $ sudo mysql -u root
    MariaDB [(none)]> set password = password("새로운 비밀번호 입력");
    - phpMyAdmin에 접속 가능
    ```

    https://www.nemonein.xyz/2019/07/2254/

    ### WordPress설치

    ```shell
    $ wget -c https://wordpress.org/latest.tar.gz
    $ tar -xvzf latest.tar.gz
    $ mv wordpress /var/www/html
    $ mv /tmp/wp-config.php /var/www/html/wordpress #미리 작성한 wp-config.php를 wordpress에 넣기
    ```

    

# ERROR



- ERROR 2002: Can`t connect to local MySQL server through socket..

- 해결 

  ```
  ln -s /tmp/mysql.sock /var/lib/mysql/mysql.sock
  ```

  

출처: https://ndb796.tistory.com/96?category=1009977 [안경잡이개발자]

---
###### 8. 학습 내용에 대한 개인적인 총평

- nginx, php, ssl인증서를 통한 https, mysql, wordpress연동까지 마무리되었다.
- 개발환경세팅을 다운로드만해봤지 직접 세팅지정하는 것은 처음이라 많이 서툴렀다. 그리고 영어자료를 좀 더 일찍 찾아볼 걸 이라는 생각도 하게 되었다. 국내자료는 많이 없어서 찾기 어려웠기 때문. 순서대로 해야할 것들을 정리해놓았기 때문에 이를 바탕으로 정말..Dockerfile과 쉘스크립트만 작성하면 마무리 될 것 같다. 중간에 데이터베이스 패스워드 지정때문에 phpMyAdmin을 계정접속할 수 없었는데 비밀번호 지정을 안해놓았기 때문이었다. wordpress는 url에 접속하면 설치만하면 되므로 해당과정까지 완료하면 되는 것 같다. 도커파일과 쉘 작성마무리는 내일로..?

---
###### 9. 다음 학습 계획 (최소 5줄 이상)

- 도커파일 작성한 후 이미지 생성하며 테스트해보기
- 내용 총 정리하기
- 에러 발생시 쉘 또는 도커 내용 수정
- cub3d 과제 내용 정리
- 안드로이드 프로젝트