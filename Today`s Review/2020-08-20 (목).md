

###### 1. 학습 날짜

- 2020 - 08 - 20(목)

---

###### 2. 학습시간

- 10:00 ~ 18:00

---

###### 3. 학습 범위 및 주제

- ft_server 도커파일 지시문 작성

---

###### 4. 동료 학습 방법 

- daelee, taelee, jehong, mihykim

---

###### 5. 학습 목표 

- 도커파일로 지시문을 작성해 서비스를 구축한다.

---

###### 6. 상세 학습 내용

- 코드작성시간 :  6 시간



## ft_server docker file 작성



<br>

도커파일이란 도커 이미지를 만들기 위한 설정파일이다.

여러 명령어를 토대로 파일을 작성하면 설정된 내용대로 image를 만들 수 있다.

도커파일을 읽을 수 있다면, 해당 이미지가 어떻게 구성되어있는지 알 수 있다.

<br>

### 도커파일 명령어

<br>

#### FROM

기반이 되는 이미지레이어

이미지이름:태그 로 작성

`FROM debian:buster`

<br>

#### MAINTAINER

메인테이너 정보 - 관리자 정보를 의미함

<br>

#### RUN

Shell 스크립트 혹은 명령을 실행한다.

`RUN apt-get update`

`RUN apt-get install -y nginx`

...

<br>

#### VOLUME

호스트와 공유할 디렉토리 목록

`VOLUME ["/data", "/etc/nginx/site-enabled", "/var/log/nginx"]`

`docker run`명령에서 `-v`옵션으로 설정 가능

`-v /root/data:/data` -> 호스트의 /root/data디렉터리를 `Docker`컨테이너의 `/data`디렉터리에 연결한다.

<br>

#### CMD

컨테이너가 시작되었을 때 실행할 실행파일 또는 스크립트

<br>

#### WORKDIR

CMD에서 설정한 실행 파일이 실행 될 디렉터리

<br>

#### EXPOSE

호스트와 연결할 포트번호

<br>

그럼 여기까지의 정보로 nginx를 설치하는 도커파일을 작성해보자

```dockerfile
FROM debian:buster
MAINTANINER secho <secho@student.42seoul.kr>

RUN apt-get update
RUN apt-get install -y nginx

CMD["nginx"]

EXPOSE 80
EXPOSE 443
```

도커파일을 작성한 다음 해당 파일을 기반으로 이미지를 생성할 수 있다.

=> CMD는 도커파일에서 한번만 사용할 수 있다고한다. RUN으로 사용해야한다.



<br>

#### 도커파일 build하기

`sudo docker build --tag ft_server:0.1 .`

현재경로에 ft_server이름의 0.1태그를 가진 이미지를 생성한다는 의미.



윽 얼른 해보고 싶다. 인터넷 휴...



도커파일에서 해야할 명령어들을 나열해보자

```dockerfile
RUN apt-get update
RUN apt-get -y upgrade
RUN apt-get -y install nginx
## nginx설치





## OpenSSL로 인증서 발급
RUN apt-get -y install openssl vim

EXPOSE 80
EXPOSE 443
```



`docker run -it -p 80:80 -p 44:3443 ft_server:nginx`로 실행해서 확인해본다.



<br>

#### nginx에 SSL설정하는 default파일 COPY하기

다하고 리팩토링해야겠다. -쉘스크립트이용해서 따로 빼자

```shell
FROM debian:buster

MAINTAINER secho <secho@student.42seoul.kr>



# nginx install


RUN apt-get update
RUN apt-get install -y nginx


# OpenSSL for certification

RUN apt-get -y install openssl vim

RUN openssl req -new -newkey rsa:2048 -nodes -keyout server.key -out server.csr -subj "/C=
US/ST=Uta/L=lehi/O=42/OU=IT/CN=yebalja.com"

RUN openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt

RUN mv ./server.crt /etc/ssl/certs
RUN mv ./server.key /etc/ssl/private


# PHP-fpm install

#WORKDIR /etc/nginx/sites-enabled/
#COPY ./config/default ./

WORKDIR /etc/nginx/sites-available/
COPY ./config/default ./

WORKDIR /var/www/html/
# copy in config/phpinfo.php to WORKDIR, current dir is WORKDIR
COPY ./config/phpinfo.php ./

RUN apt-get -y install php-fpm



# MariaDB install

RUN apt-get -y install mariadb-server php-mysql

# phpmyadmin install

RUN apt-get -y install wget
RUN wget https://files.phpmyadmin.net/phpMyAdmin/5.0.2/phpMyAdmin-5.0.2-all-languages.tar.
gz
RUN tar -xvf phpMyAdmin-5.0.2-all-languages.tar.gz
RUN mv phpMyAdmin-5.0.2-all-languages phpmyadmin

# MariaDB SET



EXPOSE 80
EXPOSE 443
```



//여기까지 phpinfo, localhost = https로 redirection 되는 것 확인

## mysql 설정시 에러발생

```
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/my
sqld.sock' (2)
```

`RUN`명령에 mysql을 추가하면 생긴다.

소켓을 통해 로컬 mysql서버에  접속할 수 없다는데..



-> `mysql ... & ...으로 해결`



### 다시 마주한 접속 에러

![image](https://user-images.githubusercontent.com/55486644/90957633-ca312800-e4c9-11ea-8ecd-839b7cb18f2f.png)

엄 원래 초기에 `mysql -u root -p`로 비밀번호 설정을 해줘야하지만 dockerfile내에서 어떻게 하는지 몰라서 ..-> 쉘스크립트로 `echo 1234 *3`하면 되려나..

아무튼 몰라서 `secho`라는 계정을 grant로 권한과 비밀번호를 부여해서 phpmyadmin에 접속했었다.

그러다보니까 root로 접속할 수가 없었고 뭔가 딴길로 샌다는 느낌을 받게 되었다.

마찬가지로 root,'%'에 권한과 비밀번호를 주었더니, 접속이 안되었다.

아마도 host가 local이 아니었기에 접속되지 않았던 것 같다.

그렇다면 root @ localhost에는 어떻게 비밀번호를 부여할까..

update문으로 root의 비밀번호를 SET해보았지만 마찬가지로 접속은 안된다.

update를 사용햐서 `mysql_native_password`라는 키워드로 비밀번호 없이 접속할 수 있는 것 같긴한데 나는 꼭 비밀번호를 넣고싶다고!..

음 아무튼, 총 3가지. 즉 root %, root localhost, secho localhost에 권한을 부여하는 sql문을 만들어서 돌려봤더니 `restart`는 되진 않지만 `root`로 접속은 할 수 있었다. 뭔가 반만된느낌이다.

내가 생각하는 방법은 mysql -u root -p로 초기 비밀번호설정을 해서 grant부여없이 접속할 수 있도록 하는것.

[초기암호설정](https://denodo1.tistory.com/303) 이걸보고 한번 해봐야겠다. mysql를 start하지 않은 상태에서가 중요한듯







==> 됐다!!!!!!!!!!!!

phpmyadmin의 config.inc.php파일에서 AllowNoPassword라는 옵션이 있었음.

이걸 `true`로 바꾸면 비밀번호 없이 로그인이 가능함.

```php
<?php
/* vim: set expandtab sw=4 ts=4 sts=4: */
/**
 * phpMyAdmin sample configuration, you can use it as base for
 * manual configuration. For easier setup you can use setup/
 *
 * All directives are explained in documentation in the doc/ folder
 * or at <https://docs.phpmyadmin.net/>.
 *
 * @package PhpMyAdmin
 */
declare(strict_types=1);

/**
 * This is needed for cookie based authentication to encrypt password in
 * cookie. Needs to be 32 chars long.
 */
$cfg['blowfish_secret'] = ''; /* YOU MUST FILL IN THIS FOR COOKIE AUTH! */

/**
 * Servers configuration
 */
$i = 0;

/**
 * First server
 */
$i++;
/* Authentication type */
$cfg['Servers'][$i]['auth_type'] = 'cookie';
/* Server parameters */
$cfg['Servers'][$i]['host'] = 'localhost';
$cfg['Servers'][$i]['compress'] = false;
$cfg['Servers'][$i]['AllowNoPassword'] = false; <-이 부분을 true로

/**
 * phpMyAdmin configuration storage settings.
 */

/* User used to manipulate with storage */
// $cfg['Servers'][$i]['controlhost'] = '';
// $cfg['Servers'][$i]['controlport'] = '';
// $cfg['Servers'][$i]['controluser'] = 'pma';
// $cfg['Servers'][$i]['controlpass'] = 'pmapass';

/* Storage database and tables */
// $cfg['Servers'][$i]['pmadb'] = 'phpmyadmin';
// $cfg['Servers'][$i]['bookmarktable'] = 'pma__bookmark';
// $cfg['Servers'][$i]['relation'] = 'pma__relation';
// $cfg['Servers'][$i]['table_info'] = 'pma__table_info';
// $cfg['Servers'][$i]['table_coords'] = 'pma__table_coords';
// $cfg['Servers'][$i]['pdf_pages'] = 'pma__pdf_pages';
// $cfg['Servers'][$i]['column_info'] = 'pma__column_info';
// $cfg['Servers'][$i]['history'] = 'pma__history';
// $cfg['Servers'][$i]['table_uiprefs'] = 'pma__table_uiprefs';
// $cfg['Servers'][$i]['tracking'] = 'pma__tracking';
// $cfg['Servers'][$i]['userconfig'] = 'pma__userconfig';
// $cfg['Servers'][$i]['recent'] = 'pma__recent';
// $cfg['Servers'][$i]['favorite'] = 'pma__favorite';
// $cfg['Servers'][$i]['users'] = 'pma__users';
// $cfg['Servers'][$i]['usergroups'] = 'pma__usergroups';
// $cfg['Servers'][$i]['navigationhiding'] = 'pma__navigationhiding';
// $cfg['Servers'][$i]['savedsearches'] = 'pma__savedsearches';
// $cfg['Servers'][$i]['central_columns'] = 'pma__central_columns';
// $cfg['Servers'][$i]['designer_settings'] = 'pma__designer_settings';
// $cfg['Servers'][$i]['export_templates'] = 'pma__export_templates';

/**
 * End of servers configuration
 */

/**
 * Directories for saving/loading files from server
 */
$cfg['UploadDir'] = '';
$cfg['SaveDir'] = '';

/**
 * Whether to display icons or text or both icons and text in table row
 * action segment. Value can be either of 'icons', 'text' or 'both'.
 * default = 'both'
 */
//$cfg['RowActionType'] = 'icons';

/**
 * Defines whether a user should be displayed a "show all (records)"
 * button in browse mode or not.
 * default = false
 */
//$cfg['ShowAll'] = true;

/**
 * Number of rows displayed when browsing a result set. If the result
 * set contains more rows, "Previous" and "Next".
 * Possible values: 25, 50, 100, 250, 500
 * default = 25
 */
//$cfg['MaxRows'] = 50;

/**
 * Disallow editing of binary fields
 * valid values are:
 *   false    allow editing
 *   'blob'   allow editing except for BLOB fields
 *   'noblob' disallow editing except for BLOB fields
 *   'all'    disallow editing
 * default = 'blob'
 */
//$cfg['ProtectBinary'] = false;

/**
 * Default language to use, if not browser-defined or user-defined
 * (you find all languages in the locale folder)
 * uncomment the desired line:
 * default = 'en'
 */
```

[참고링크](https://sheldon.co.kr/xampp-mysql-root-resetting/)





### foreground에서 nginx가 실행되도록 하기.

**Docker 컨테이너** 또는 디버깅을 위해 `daemon off;` 지시문은 Nginx가 포 그라운드에 머물도록 지시합니다.

docker를 background에서 실행하려면 -d옵션을 지정해주어야한다.

foreground에서 바로 이미지를 실행하고자 하면 nginx에서 `nginx -g daemon



---

###### 7. 학습 내용에 대한 개인적인 총평

- 정말 오래 걸렸다. 금방 할 줄 알았는데 도중에 오류도 발생하고 현재 인터넷이 없어서 핫스팟환경에서 진행하느라 더욱 오래걸린다..
- 클러스터였으면 금방했을텐데 앞으로 과제진행에 차질이 많을 것 같다.
- 이전에 팀프로젝트를 진행하면서 서버에 대한 키워드를 조금 알게되어서 문제가 생겼을 때 알고 있던 키워드 중심으로 검색하니 먼길을 돌아가지 않아도 되었다.

###### 8. 다음 학습 계획

- HTTP스터디