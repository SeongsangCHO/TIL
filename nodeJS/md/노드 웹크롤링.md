## 노드 웹크롤링



[코드 예제](https://github.com/ZeroCho/nodejs-crawler)

### 1.1 웹 크롤러소개

- CRAWL : 기어다니다
- 웹 사이트를 기어다니면서 정보를 수집하는 봇 = 크롤러
- 크롤링한걸 영리적 목적으로 쓸 때 문제가 생길수도 있음.
- 자스로 크롤링하면 생산성이 좋당

---

### 1.2 CSV - Parse 패키지로 csv 파싱하기

- CSV? comma separated values
  - 콤마와 줄바꿈으로 구분된 값
- `npm i csv-parse` : csv를 parse하는 모듈

```javascript
//모듈을 사용하기 위한 부분
const parse = require('csv-parse/lib/sync');
//csv 파일을 읽어오기 위한 모듈
const fs = require('fs');
//csv는 버퍼형식임. csv파일을 읽어옴
const csv = fs.readFileSync('csv/data.csv');
//0,1로 이루어진 버퍼를 문자열로 변환해줌
//parse메서드가 문자열을 2차원 배열로 바꿔줌
const records = parse(csv.toString('utf-8'));
records.forEach((r, i) => {
  console.log(i, r);
});
```



---

### 1.3 xlsx 패키지로 엑셀 파싱하기



```javascript
const xlsx = require('xlsx');


//readfile로 엑셀파일 읽기
const workbook = xlsx.readFile('xlsx/data.xlsx');
console.log(Object.keys(workbook.Sheets)); // TODO: workbook.SheetNames
const ws = workbook.Sheets.영화목록;
const records = xlsx.utils.sheet_to_json(ws); // TODO: 강좌에서 header 옵션 보여주기
//entries()로 사용하면 객체가 [인덱스, 값]형태 이터레이터로 변환됨.
for (const [i, r] of records.entries()) {
  console.log(i, r);
}
```



---

### 1.4 axios-cheerio로 첫 크롤링하기 (엑셀파일의 url로 요청 -> 파싱하여 엑셀에 write)

가장 간편하게 크롤링하는 방법

axios + cheerio 조합으로 가능

- axios : ajax 라이브러리, 페이지를 요청하고 html을 응답받음
- cheerio : html 파싱

```javascript
  
const xlsx = require('xlsx');
const axios = require('axios');
const cheerio = require('cheerio');
const add_to_sheet = require('./add_to_sheet');

const workbook = xlsx.readFile('xlsx/data.xlsx');
const ws = workbook.Sheets.영화목록;
const records = xlsx.utils.sheet_to_json(ws);

const crawler = async () => {
  add_to_sheet(ws, 'C1', 's', '평점');
  await Promise.all(records.map(async (r) => {
      //링크에 get요청을 보낸다
    const response = await axios.get(r.링크);
      //요청이 성공했으면,
    if (response.status === 200) {
      const html = response.data;
        //html = html 문자열 cheerio로 로드-> 태그들에 접근 가능함
      const $ = cheerio.load(html);
        //css선택자로 원하는 태그를 선택할 수 있어야한다.
      const text = $('.score.score_left .star_score').text();
      console.log(r.제목, '평점', text.trim());
      const newCell = 'C' + (i + 2);
      add_to_sheet(ws, newCell, 'n', text.trim());
    }
  }));
  xlsx.writeFile(workbook, 'xlsx/result.xlsx');
};
crawler();
```



---

### 1.5 promise, all과 for of문의 차이

---

